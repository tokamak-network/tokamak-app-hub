name: Auto Add App from Issue

on:
  issues:
    types: [opened, labeled]

jobs:
  add-app:
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'approved') ||
      (github.event.action == 'opened' && (contains(github.event.issue.labels.*.name, 'app-submission') || contains(github.event.issue.title, '[App Submission]')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Check if auto-approve needed (for opened issues)
        if: github.event.action == 'opened'
        id: check-user
        uses: actions/github-script@v7
        env:
          ALLOWED_USERS: ${{ secrets.ALLOWED_USERS }}
        with:
          script: |
            const issueAuthor = context.payload.issue.user.login;
            const allowedUsers = (process.env.ALLOWED_USERS || '').split(',').map(u => u.trim().toLowerCase());
            
            console.log(`Issue author: ${issueAuthor}`);
            console.log(`Allowed users count: ${allowedUsers.length}`);
            
            if (allowedUsers.includes(issueAuthor.toLowerCase())) {
              console.log(`âœ… ${issueAuthor} is an allowed user.`);
              core.setOutput('approved', 'true');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `ðŸ¤– Auto-approved: @${issueAuthor} is a verified team member. Processing...`
              });
            } else {
              console.log(`â³ ${issueAuthor} is not in the allowed list.`);
              core.setOutput('approved', 'false');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `â³ Waiting for maintainer approval. A maintainer will review and add the \`approved\` label.`
              });
            }

      - name: Exit if not approved
        if: github.event.action == 'opened' && steps.check-user.outputs.approved != 'true'
        run: |
          echo "User not in allowed list. Exiting."
          exit 0

      - name: Checkout repository
        if: github.event.action == 'labeled' || steps.check-user.outputs.approved == 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: github.event.action == 'labeled' || steps.check-user.outputs.approved == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse Issue and Add App
        if: github.event.action == 'labeled' || steps.check-user.outputs.approved == 'true'
        id: add-app
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body;
            
            function parseField(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : null;
            }
            
            const githubUrl = parseField(body, 'GitHub Repository URL');
            const category = parseField(body, 'Category');
            const tagsRaw = parseField(body, 'Tags');
            const shortDescription = parseField(body, 'Short Description');
            
            if (!githubUrl || !category || !shortDescription) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âŒ Missing required fields. Please ensure GitHub URL, Category, and Short Description are provided.'
              });
              core.setOutput('success', 'false');
              return;
            }
            
            const urlMatch = githubUrl.match(/github\.com\/([^\/]+)\/([^\/\s]+)/);
            if (!urlMatch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âŒ Invalid GitHub URL format.'
              });
              core.setOutput('success', 'false');
              return;
            }
            
            const [, owner, repo] = urlMatch;
            const repoName = repo.replace(/\.git$/, '');
            
            let repoInfo;
            try {
              const { data } = await github.rest.repos.get({
                owner: owner,
                repo: repoName
              });
              repoInfo = data;
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ Could not fetch repository info. Please check the URL: ${githubUrl}`
              });
              core.setOutput('success', 'false');
              return;
            }
            
            const appsPath = 'data/apps.json';
            const apps = JSON.parse(fs.readFileSync(appsPath, 'utf8'));
            
            const isDuplicate = apps.some(app => 
              app.githubUrl.toLowerCase() === githubUrl.toLowerCase() ||
              app.slug === repoName.toLowerCase()
            );
            
            if (isDuplicate) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âŒ This app is already registered in the hub.'
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              core.setOutput('success', 'false');
              return;
            }
            
            const validCategories = ['dapp', 'smart-contract', 'sdk', 'tool', 'ai', 'zk', 'other'];
            if (!validCategories.includes(category)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ Invalid category. Must be one of: ${validCategories.join(', ')}`
              });
              core.setOutput('success', 'false');
              return;
            }
            
            const newApp = {
              id: crypto.randomUUID(),
              slug: repoName.toLowerCase(),
              name: repoInfo.name,
              description: repoInfo.description || shortDescription,
              shortDescription: shortDescription.substring(0, 100),
              category: category,
              tags: tagsRaw ? tagsRaw.split(',').map(t => t.trim().toLowerCase()).filter(Boolean) : [],
              githubUrl: githubUrl,
              githubOwner: owner,
              githubRepo: repoName,
              stars: repoInfo.stargazers_count,
              forks: repoInfo.forks_count,
              language: repoInfo.language,
              author: repoInfo.owner.login,
              authorAvatar: repoInfo.owner.avatar_url,
              status: 'active',
              featured: false,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            
            apps.push(newApp);
            fs.writeFileSync(appsPath, JSON.stringify(apps, null, 2) + '\n');
            
            core.exportVariable('APP_NAME', newApp.name);
            core.exportVariable('APP_SLUG', newApp.slug);
            core.exportVariable('ISSUE_NUMBER', issue.number);
            core.setOutput('success', 'true');

      - name: Commit and Push
        if: steps.add-app.outputs.success == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/apps.json
          git commit -m "feat: add ${APP_NAME} to app hub (closes #${ISSUE_NUMBER})"
          git push

      - name: Comment on Issue and Close
        if: steps.add-app.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const appName = process.env.APP_NAME;
            const appSlug = process.env.APP_SLUG;
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              labels: ['approved']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              body: `âœ… **${appName}** has been added to Tokamak App Hub!\n\nView it at: https://tokamak-app-hub.vercel.app/apps/${appSlug}`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              state: 'closed'
            });
