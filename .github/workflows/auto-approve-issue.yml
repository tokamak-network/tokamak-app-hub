name: Auto Approve App Submission

on:
  issues:
    types: [opened]

jobs:
  auto-approve:
    if: contains(github.event.issue.labels.*.name, 'app-submission') || contains(github.event.issue.title, '[App Submission]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Check if user is allowed and auto-approve
        uses: actions/github-script@v7
        env:
          ALLOWED_USERS: ${{ secrets.ALLOWED_USERS }}
        with:
          script: |
            const issueAuthor = context.payload.issue.user.login;
            const allowedUsers = (process.env.ALLOWED_USERS || '').split(',').map(u => u.trim().toLowerCase());
            
            console.log(`Issue author: ${issueAuthor}`);
            console.log(`Allowed users: ${allowedUsers.join(', ')}`);
            
            if (allowedUsers.includes(issueAuthor.toLowerCase())) {
              console.log(`‚úÖ ${issueAuthor} is an allowed user. Adding approved label.`);
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['approved']
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `ü§ñ Auto-approved: @${issueAuthor} is a verified team member.`
              });
            } else {
              console.log(`‚è≥ ${issueAuthor} is not in the allowed list. Waiting for manual approval.`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `‚è≥ Waiting for maintainer approval. A maintainer will review and add the \`approved\` label.`
              });
            }
